name: Selenium CI with Email and Slack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      CI: true   # Explicitly define CI environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Install dependencies
        run: mvn clean install -DskipTests --batch-mode

      - name: Run Selenium tests
        run: mvn test --batch-mode 2>&1 | tee output.log
        continue-on-error: true

      # --------------------------------------------------------
      # Extract real test result info (handles Errors + Failures)
      # --------------------------------------------------------
      - name: Extract test results
        id: extract_step
        run: |
          LOG_FILE="output.log"

          # Extract overall summary
          TEST_STATUS=$(grep "Tests run:" "$LOG_FILE" | tail -n 1)

          # Extract first failing test method
          FAILING_TEST=$(grep "<<< FAILURE!" "$LOG_FILE" | head -n 1 | awk '{print $(NF-2)}')

          # If no FAILURE, check for ERROR
          if [ -z "$FAILING_TEST" ]; then
            FAILING_TEST=$(grep "<<< ERROR!" "$LOG_FILE" | head -n 1 | awk '{print $(NF-2)}')
          fi

          # Extract first exception type
          FAILURE_REASON=$(grep -E "Exception|Error:" "$LOG_FILE" | head -n 1)

          # Extract file + line
          FAILING_FILE=$(grep "at com.qa." "$LOG_FILE" | head -n 1 | sed 's/.*(\(.*\))/\1/')

          # If nothing failed
          if echo "$TEST_STATUS" | grep -q "Failures: 0, Errors: 0"; then
            FAILING_TEST="None"
            FAILING_FILE="N/A"
            FAILURE_REASON="All tests passed"
          fi

          echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_ENV
          echo "FAILING_TEST=$FAILING_TEST" >> $GITHUB_ENV
          echo "FAILING_FILE=$FAILING_FILE" >> $GITHUB_ENV
          echo "FAILURE_REASON=$FAILURE_REASON" >> $GITHUB_ENV

      # -----------------------
      # Slack Notification
      # -----------------------
      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,workflow,job,took
          text: |
            *Selenium Test Execution Result*

            *Summary:* `${{ env.TEST_STATUS }}`
            *Failing Test:* `${{ env.FAILING_TEST }}`
            *Location:* `${{ env.FAILING_FILE }}`
            *Reason:* `${{ env.FAILURE_REASON }}`

            Full Logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # -----------------------
      # Email Notification
      # -----------------------
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Selenium Test Results - ${{ github.repository }}"
          body: |
            Build Status: ${{ job.status }}

            Test Summary:
            ${{ env.TEST_STATUS }}

            Failing Test:
            ${{ env.FAILING_TEST }}

            File/Line:
            ${{ env.FAILING_FILE }}

            Reason:
            ${{ env.FAILURE_REASON }}

            View Full Execution:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>

      # -----------------------
      # Upload Reports
      # -----------------------
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/

      # -----------------------
      # Fail workflow if needed
      # -----------------------
      - name: Fail workflow if tests failed
        if: |
          !contains(env.TEST_STATUS, 'Failures: 0') ||
          !contains(env.TEST_STATUS, 'Errors: 0')
        run: exit 1

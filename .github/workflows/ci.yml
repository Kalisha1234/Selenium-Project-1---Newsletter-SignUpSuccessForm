#name: Selenium CI with Email and Slack
#
#on:
#  push:
#    branches: [ main ]
#  pull_request:
#    branches: [ main ]
#
#jobs:
#  test:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 25
#        uses: actions/setup-java@v4
#        with:
#          java-version: '25'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Install dependencies
#        run: mvn clean install -DskipTests --batch-mode
#
#      - name: Run Selenium tests
#        # Using 'tee' to capture the log for parsing while still showing it in the console
#        run: mvn test --batch-mode 2>&1 | tee output.log
#        continue-on-error: true
#
#      - name: Extract test results
#        id: extract_step
#        run: |
#          LOG_FILE="output.log"
#
#          # 1. Extract which test is failing (e.g., com.qa.NewsletterPOMTest.testPageLoadsWithHeading)
#          FAILING_TEST=$(grep "<<< FAILURE! - in" "$LOG_FILE" | head -n 1 | awk '{print $NF}' || echo "None")
#
#          # 2. Extract the specific file and line number from the stack trace
#          FAILING_FILE=$(grep "at com.qa." "$LOG_FILE" | head -n 1 | sed 's/.*(\(.*\))/\1/' || echo "Unknown")
#
#          # 3. Extract the failure reason (Assertion message)
#          FAILURE_REASON=$(grep "AssertionFailedError:" "$LOG_FILE" | head -n 1 | sed 's/.*AssertionFailedError: //' || echo "N/A")
#
#          # 4. Extract the general summary (Tests run, Failures, etc.)
#          TEST_STATUS=$(grep "Tests run:" "$LOG_FILE" | tail -n 1 || echo "No test summary found")
#
#          # Export to GITHUB_ENV for subsequent steps
#          echo "FAILING_TEST=$FAILING_TEST" >> $GITHUB_ENV
#          echo "FAILING_FILE=$FAILING_FILE" >> $GITHUB_ENV
#          echo "FAILURE_REASON=$FAILURE_REASON" >> $GITHUB_ENV
#          echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_ENV
#
#      - name: Send Slack notification
#        if: always()
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
#          text: |
#            *Selenium Test Results Summary:*
#            *Status:* `${{ env.TEST_STATUS }}`
#            *Failing Test:* `${{ env.FAILING_TEST }}`
#            *File/Line:* `${{ env.FAILING_FILE }}`
#            *Reason:* `${{ env.FAILURE_REASON }}`
#
#            View Full Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#
#      - name: Send email notification
#        if: always()
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 465
#          username: ${{ secrets.EMAIL_USERNAME }}
#          password: ${{ secrets.EMAIL_PASSWORD }}
#          subject: "Selenium Tests  - ${{ github.repository }}"
#          body: |
#            Build Status: ${{ job.status }}
#
#            Test Details:
#            - Summary: ${{ env.TEST_STATUS }}
#            - Failing Test: ${{ env.FAILING_TEST }}
#            - File/Line: ${{ env.FAILING_FILE }}
#            - Reason: ${{ env.FAILURE_REASON }}
#
#            You can view the full execution here:
#            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
#          to: ${{ secrets.EMAIL_TO }}
#          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
#
#      - name: Upload test reports
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: test-reports
#          path: target/surefire-reports/
#
#      - name: Fail workflow if tests failed
#        # This ensures the pipeline actually shows as 'failed' in GitHub if any tests were unsuccessful
#        if: |
#          !contains(env.TEST_STATUS, 'Failures: 0') ||
#          !contains(env.TEST_STATUS, 'Errors: 0')
#        run: exit 1
#
#
name: Selenium CI with Email and Slack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Install dependencies
        run: mvn clean install -DskipTests --batch-mode

      - name: Run Selenium tests
        run: mvn test --batch-mode 2>&1 | tee output.log
        continue-on-error: true

      - name: Extract test results
        id: extract_step
        run: |
          LOG_FILE="output.log"

          # Extract the general summary (Tests run, Failures, etc.)
          TEST_STATUS=$(grep "Tests run:" "$LOG_FILE" | tail -n 1 || echo "No test summary found")

          # Extract failure and error counts
          FAILURES=$(echo "$TEST_STATUS" | grep -oP 'Failures: \K\d+' || echo "0")
          ERRORS=$(echo "$TEST_STATUS" | grep -oP 'Errors: \K\d+' || echo "0")

          echo "STATUS: $TEST_STATUS"
          echo "FAILURES: $FAILURES"
          echo "ERRORS: $ERRORS"

          # Only extract failure details if there are actual failures or errors
          if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
            echo "Extracting failure details..."
          
            # Extract which test class is failing
            FAILING_TEST=$(grep -E "<<< FAILURE!|<<< ERROR!" "$LOG_FILE" | head -n 1 | awk '{print $NF}' || echo "Unknown")
          
            # If still empty, try to get from "Running" lines before failures
            if [ "$FAILING_TEST" = "Unknown" ] || [ -z "$FAILING_TEST" ]; then
              FAILING_TEST=$(grep "Tests run:" "$LOG_FILE" | grep -v "Time elapsed" | head -n 1 | awk '{print $4}' || echo "Check logs")
            fi
          
            # Extract the specific file and line number from the stack trace
            FAILING_FILE=$(grep -E "^\s*at com\.qa\." "$LOG_FILE" | head -n 1 | sed -E 's/.*\(([^)]+)\).*/\1/' || echo "Unknown")
          
            # If no file found, try alternative pattern
            if [ "$FAILING_FILE" = "Unknown" ] || [ -z "$FAILING_FILE" ]; then
              FAILING_FILE=$(grep -oP '\(.*?\.java:\d+\)' "$LOG_FILE" | head -n 1 | tr -d '()' || echo "Check logs")
            fi
          
            # Extract the failure reason - try multiple patterns
            FAILURE_REASON=$(grep -E "AssertionFailedError:|Exception:|Error:" "$LOG_FILE" | grep -v "at com.qa" | grep -v "at org." | grep -v "at java." | head -n 1 | sed -E 's/.*Error: //; s/.*Exception: //; s/^\s+//' || echo "")
          
            # If still empty, try to get the error message from a different pattern
            if [ -z "$FAILURE_REASON" ]; then
              FAILURE_REASON=$(grep -A 2 -E "<<< FAILURE!|<<< ERROR!" "$LOG_FILE" | grep -v "<<<" | grep -v "^--$" | head -n 1 | sed 's/^\s*//' || echo "Check full logs for error details")
            fi
          
            # If still empty, provide a helpful default
            if [ -z "$FAILURE_REASON" ]; then
              FAILURE_REASON="Error details not captured - check full logs"
            fi
          
            BUILD_RESULT="failure"
          
            echo "FAILING_TEST: $FAILING_TEST"
            echo "FAILING_FILE: $FAILING_FILE"
            echo "FAILURE_REASON: $FAILURE_REASON"
          else
            FAILING_TEST="N/A - All tests passed"
            FAILING_FILE="N/A"
            FAILURE_REASON="N/A"
            BUILD_RESULT="success"
          fi

          # Export to GITHUB_ENV for subsequent steps
          {
            echo "FAILING_TEST=$FAILING_TEST"
            echo "FAILING_FILE=$FAILING_FILE"
            echo "FAILURE_REASON<<EOF"
            echo "$FAILURE_REASON"
            echo "EOF"
            echo "TEST_STATUS=$TEST_STATUS"
            echo "FAILURES=$FAILURES"
            echo "ERRORS=$ERRORS"
            echo "BUILD_RESULT=$BUILD_RESULT"
          } >> $GITHUB_ENV

      - name: Debug - Show extracted values
        if: always()
        run: |
          echo "=== Extracted Values ==="
          echo "BUILD_RESULT: ${{ env.BUILD_RESULT }}"
          echo "TEST_STATUS: ${{ env.TEST_STATUS }}"
          echo "FAILING_TEST: ${{ env.FAILING_TEST }}"
          echo "FAILING_FILE: ${{ env.FAILING_FILE }}"
          echo "FAILURE_REASON: ${{ env.FAILURE_REASON }}"

      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          text: |
            *Selenium Test Results Summary:*
            *Build Result:* `${{ env.BUILD_RESULT }}`
            *Status:* `${{ env.TEST_STATUS }}`
            *Failing Test:* `${{ env.FAILING_TEST }}`
            *File/Line:* `${{ env.FAILING_FILE }}`
            *Reason:* `${{ env.FAILURE_REASON }}`

            View Full Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Selenium Tests - ${{ env.BUILD_RESULT }} - ${{ github.repository }}"
          body: |
            Build Status: ${{ env.BUILD_RESULT }}

            Test Details:
            - Summary: ${{ env.TEST_STATUS }}
            - Failing Test: ${{ env.FAILING_TEST }}
            - File/Line: ${{ env.FAILING_FILE }}
            - Reason: ${{ env.FAILURE_REASON }}

            You can view the full execution here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/

      - name: Upload output log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-output
          path: output.log

      - name: Fail workflow if tests failed
        run: |
          echo "Failures=${{ env.FAILURES }}, Errors=${{ env.ERRORS }}"
          if [ "${{ env.FAILURES }}" -gt 0 ] || [ "${{ env.ERRORS }}" -gt 0 ]; then
            echo "Tests failed or had errors. Failing workflow..."
            exit 1
          else
            echo "All tests passed. Workflow will succeed."
          fi
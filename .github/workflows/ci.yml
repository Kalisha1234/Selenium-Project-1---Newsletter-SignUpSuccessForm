#name: Selenium CI Pipeline
#
#on:
#  push:
#    branches: [ main]
#  pull_request:
#    branches: [ main]
#
#jobs:
#  test:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      - name: Set up JDK 11
#        uses: actions/setup-java@v3
#        with:
#          java-version: '11'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Install dependencies
#        run: mvn clean install -DskipTests
#
#      - name: Run Selenium tests
#        run: mvn test
#        #continue-on-error: true
#
#      - name: Upload test reports
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: test-reports
#          path: target/surefire-reports/
#          retention-days: 30
#
#      - name: Send email notification
#        if: always()
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 465
#          username: ${{ secrets.EMAIL_USERNAME }}
#          password: ${{ secrets.EMAIL_PASSWORD }}
#          subject: "Selenium Tests ${{ job.status }} - ${{ github.repository }}"
#          body: |
#            Build Status: ${{ job.status }}
#            Repository: ${{ github.repository }}
#            Branch: ${{ github.ref }}
#            Commit: ${{ github.sha }}
#            Workflow: ${{ github.workflow }}
#            Run: ${{ github.run_number }}
#
#            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
#          to: ${{ secrets.EMAIL_TO }}
#          from: GitHub Actions



name: Selenium CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Install dependencies
        run: mvn clean install -DskipTests --batch-mode

      - name: Run Selenium tests
        id: run_tests
        run: |
          mvn test --batch-mode 2>&1 | tee test-output.log
          echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse test results
        id: parse_results
        if: always()
        run: |
          # Determine overall status
          if grep -q "BUILD SUCCESS" test-output.log; then
            echo "STATUS=success" >> $GITHUB_OUTPUT
          else
            echo "STATUS=failure" >> $GITHUB_OUTPUT
          fi

          # Grab Maven summary lines
          SUMMARY=$(grep -E "Tests run:|BUILD" test-output.log | tail -5 || echo "No summary available")
          echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Build failure detail from surefire plain reports
          FAIL_DETAIL=""
          for f in target/surefire-reports/*.txt; do
            [ -f "$f" ] || continue
            CLASS=$(basename "$f" .txt)
            if grep -qE "FAILED|<<< FAILURE|<<< ERROR" "$f" 2>/dev/null; then
              FAIL_DETAIL="${FAIL_DETAIL}\n--- ${CLASS} ---\n"
              FAIL_DETAIL="${FAIL_DETAIL}$(grep -A 5 -E "FAILED|AssertionError|Expected|but was|<<< FAILURE|<<< ERROR" "$f" | head -30)\n"
            fi
          done

          if [ -z "$FAIL_DETAIL" ] && grep -q "BUILD FAILURE" test-output.log; then
            FAIL_DETAIL=$(tail -40 test-output.log)
          fi

          echo "FAIL_DETAIL<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAIL_DETAIL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            test-output.log
          retention-days: 30

      - name: Send email notification on failure
        if: steps.parse_results.outputs.STATUS == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ Selenium Tests FAILED - ${{ github.repository }}"
          body: |
            Build Status: FAILED
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}

            ── FAILED TESTS ──────────────────────────────
            ${{ steps.parse_results.outputs.FAIL_DETAIL }}

            ── MAVEN SUMMARY ─────────────────────────────
            ${{ steps.parse_results.outputs.SUMMARY }}

            View full logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>

      - name: Send email notification on success
        if: steps.parse_results.outputs.STATUS == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "✅ Selenium Tests PASSED - ${{ github.repository }}"
          body: |
            Build Status: success
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>

      - name: Fail workflow if tests failed
        if: steps.parse_results.outputs.STATUS == 'failure'
        run: exit 1
